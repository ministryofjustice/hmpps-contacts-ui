{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}

{% macro nameChangeHistory(opts) %}
  {% set changes = opts.nameChanges or [] %}
  {% if changes | length > 0 %}
    <div class="app-name-change-history" data-qa="name-change-history">
      <h2 class="govuk-heading-m govuk-!-margin-bottom-2">Latest name changes</h2>

      {% if opts.featureStartDate %}

          {% set nameChangeHistoryWarningHtml %}
              <strong>
                Names changed before {{ opts.featureStartDate | formatDate }} will not be shown.
              </strong>
          {% endset -%}

        {{ govukWarningText({
            html: nameChangeHistoryWarningHtml,
            iconFallbackText: "Warning"
          }) }}
      {% endif %}

      {% set latest = changes[0] %}
      {% set latestNewNameParts = [latest.newFirstName, latest.newMiddleNames, latest.newLastName] | reject("equalto", "") %}
      {% set latestPrevNameParts = [latest.previousFirstName, latest.previousMiddleNames, latest.previousLastName] | reject("equalto", "") %}
      {% set latestNewName = (latest.newName or latestNewNameParts | join(" ")) | trim %}
      {% set latestPreviousName = (latest.previousName or latestPrevNameParts | join(" ")) | trim %}
      {% set latestUpdatedBy = latest.updatedByName or latest.updatedBy or 'Not provided' %}
      {% set latestChangedOn = (latest.changedOn | formatDate) if latest.changedOn else 'Not provided' %}

      {{ govukSummaryList({
        card: {
          title: { text: 'Latest name change' },
          classes: 'summary-card-wider-key-column'
        },
        rows: [
          {
            key: { text: 'Date of name change' },
            value: { text: latestChangedOn }
          },
          {
            key: { text: 'New name' },
            value: { text: latestNewName or 'Not provided' }
          },
          {
            key: { text: 'Previous name' },
            value: { text: latestPreviousName or 'Not provided' }
          },
          {
            key: { text: 'Name updated by' },
            value: { text: latestUpdatedBy }
          }
        ],
        attributes: {"data-qa": "latest-history-card"}
      }) }}

      {% if changes | length > 1 %}
          {% for change in changes %}
            {% if not loop.first %}
            {% set index = loop.index %}
            {% set newParts = [change.newFirstName, change.newMiddleNames, change.newLastName] | reject("equalto", "") %}
            {% set prevParts = [change.previousFirstName, change.previousMiddleNames, change.previousLastName] | reject("equalto", "") %}
            {% set newName = (change.newName or newParts | join(" ")) | trim %}
            {% set previousName = (change.previousName or prevParts | join(" ")) | trim %}
            {% set updatedBy = change.updatedByName or change.updatedBy or 'Not provided' %}
            {% set changedOn = (change.changedOn | formatDate) if change.changedOn else 'Not provided' %}

            {{ govukSummaryList({
              card: {
                title: { text: 'Previous name change ' + (index -1)},
                classes: 'summary-card-wider-key-column'
              },
              rows: [
                { key: { text: 'Date of name change' }, value: { text: changedOn } },
                { key: { text: 'New name' }, value: { text: newName or 'Not provided' } },
                { key: { text: 'Previous name' }, value: { text: previousName or 'Not provided' } },
                { key: { text: 'Name updated by' }, value: { text: updatedBy } }
              ],
              attributes: {"data-qa": "previous-history-card-"  + index}
            }) }}
            {% endif %}
          {% endfor %}
      {% endif %}
    </div>
  {% endif %}
{% endmacro %}